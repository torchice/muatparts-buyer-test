"use client";
import { useEffect, useState } from "react";
import style from "./Checkout.module.scss";
import IconComponent from "@/components/IconComponent/IconComponent";
import OrderCard from "@/components/OrderCard/OrderCard";
import RingkasanPembayaran from "@/containers/RingkasanPembayaran/RingkasanPembayaran";
import { useLanguage } from "@/context/LanguageContext";
import ModalComponent from "@/components/Modals/ModalComponent";
import Button from "@/components/Button/Button";

function CheckoutWeb({
  resDetailCheckout,
  dataShippingCost,
  supportingDataCheckoutDetail,
  paymentData,
  onClickPay,
}) {
  const { t } = useLanguage();
  const [detailCheckout, setDetailCheckout] = useState([]);
  const [loading, setLoading] = useState(true);

  const [modalHargaBeda, setModalHargaBeda] = useState(false);

  const handleSelectShippingCost = (updatedOrder, index) => {
    const updatedDataCheckoutDetail = [...detailCheckout];
    updatedDataCheckoutDetail[index] = updatedOrder;

    setDetailCheckout(updatedDataCheckoutDetail);
  };

  const handleOnUseVoucher = (index, data) => {
    setDetailCheckout((prevCarts) => {
      const newCarts = [...prevCarts];
      newCarts[index] = {
        ...newCarts[index],
        usedVouchers: data,
      };
      return newCarts;
    });
  };

  // 25. 03 - QC Plan - Web - Pengecekan Ronda Muatparts - Tahap 2 - LB - 0393
  const updateProductNote = (orderIndex, productIndex, newNote) => {
    setDetailCheckout((prevOrders) => {
      const newOrders = [...prevOrders];
      newOrders[orderIndex] = {
        ...newOrders[orderIndex],
        products: [...newOrders[orderIndex].products],
      };

      // Update the specific product's note
      newOrders[orderIndex].products[productIndex] = {
        ...newOrders[orderIndex].products[productIndex],
        notes: newNote,
      };

      return newOrders;
    });
  };

  useEffect(() => {
    if (resDetailCheckout.length) {
      console.log("detail Checkout",resDetailCheckout)
      setDetailCheckout(resDetailCheckout);
      setLoading(false);
    }
  }, [resDetailCheckout]);
  
  useEffect(() => {
    if (!supportingDataCheckoutDetail?.checkPromo) {
      setModalHargaBeda(false)
    } else {
      setModalHargaBeda(true)
    }
  }, [supportingDataCheckoutDetail?.checkPromo]);

  const handleChangeAddress = async (val, index) => {
    const updatedDataCheckoutDetail = [...detailCheckout];

    if (updatedDataCheckoutDetail[index]) {
      updatedDataCheckoutDetail[index].shippingAddress = val;
      await setDetailCheckout(updatedDataCheckoutDetail);
    }
  };

  return (
    <div className={style.main}>
      <div className="flex gap-3 mb-4">
        <h1 className="text-xl font-bold">
          {t("AppMuatpartsDaftarPesananBuyerDetailPesanan")}
        </h1>
      </div>

      <div className="flex gap-2 items-center bg-secondary-100 px-6 py-4 rounded-md text-xs font-medium mb-4">
        <IconComponent
          width={20}
          height={20}
          icon="warning"
          src={"/icons/warning-outline.svg"}
          color="warning"
        />
        {/* 25. 03 - QC Plan - Web - Pengecekan Ronda Muatparts - Tahap 2 LB - 0826 */}
        <div className="">
          {/* Improvement fix wording pak Brian */}
          {t("LabelcheckoutWebMohonpastikankembalipesanankamusudahsesuai.Iniadalahlangkahterakhirsebelumpembayaran.")}
        </div>
      </div>

      <div className="flex gap-4">
        <div className="w-[846px]">
          {loading ? (
            <>
              <div className="animate-pulse px-8 py-5 shadow-muatmuat rounded-xl space-y-3">
                <div className="h-4 bg-gray-200 rounded w-1/4"></div>
                <div className="flex justify-between">
                  <div className="flex items-center gap-2">
                    <div className="h-6 w-6 bg-gray-200 rounded-full"></div>
                    <div className="h-4 bg-gray-200 rounded w-16"></div>
                  </div>
                  <div className="h-4 bg-gray-200 rounded w-1/4"></div>
                </div>
                <div className="h-4 bg-gray-200 rounded w-1/2"></div>
                <div className="h-4 bg-gray-200 rounded w-1/2"></div>
                <div className="space-y-2">
                  <div className="h-4 bg-gray-200 rounded"></div>
                  <div className="h-4 bg-gray-200 rounded w-5/6"></div>
                </div>
                <div className="h-4 bg-gray-200 rounded w-1/2"></div>
                <div className="h-4 bg-gray-200 rounded w-1/2"></div>
              </div>
            </>
          ) : (
            detailCheckout?.map((order, index) => (
              <OrderCard
                order={order}
                orderIndex={index}
                key={index}
                onSelectShippingCost={(val) =>
                  handleSelectShippingCost(val, index)
                }
                onChangeAddress={(val) => handleChangeAddress(val, index)}
                onUseVoucher={handleOnUseVoucher}
                updateProductNote={updateProductNote}
              />
            ))
          )}
        </div>

        <div className="w-[338px]">
          <RingkasanPembayaran
            orders={detailCheckout ?? []}
            applicationFee={supportingDataCheckoutDetail?.appFee}
            submittedVoucher={{
              purchase: supportingDataCheckoutDetail?.usedVoucherPurchaseMP,
              shipping: supportingDataCheckoutDetail?.usedVoucherShippingMP,
            }}
            paymentData={paymentData}
            onClickPay={(val) => onClickPay(val)}
          />
        </div>
      </div>


      <ModalComponent isOpen={modalHargaBeda} setClose={() => setModalHargaBeda(false)}>
        <div className="w-[386px] text-center py-9 px-6 !font-medium !text-sm">
          <>{supportingDataCheckoutDetail?.checkPromo}</>
          <Button children="OK" Class="!h-8 !mx-auto !mt-6 !font-semibold" onClick={() => setModalHargaBeda(false)} />
        </div>
      </ModalComponent>
    </div>
  );
}

export default CheckoutWeb;
