'use client';
import { useEffect, useState } from 'react';
import style from './Products.module.scss';
import IconComponent from '@/components/IconComponent/IconComponent';
import Dropdown from '@/components/Dropdown/Dropdown';
import FilterProductsWeb from '@/containers/FilterProductsWeb/FilterProductsWeb';
import ProductComponent from '@/components/ProductComponent/ProductComponent';
import StoreCardComponent from '@/components/StoreCardComponent/StoreCardComponent';
import DataNotFound from '@/components/DataNotFound/DataNotFound';
import Button from '@/components/Button/Button';
import Input from '@/components/Input/Input';
import Toast from '@/components/Toast/Toast';
import toast from '@/store/toast';
import MultipleItems from '@/components/ReactSlick/MultipleItems';
import { useLanguage } from '@/context/LanguageContext';
import Bubble from '@/components/Bubble/Bubble';
import CarouselScrollComponent from '@/components/CarouselScrollComponent/CarouselScrollComponent';
import ProductComponentSkeleton from '@/components/ProductComponent/ProductComponentSkeleton';
import Pagination from '../ulasanbuyer/PaginationUlasan';
import { userLocationZustan } from '@/store/manageLocation/managementLocationZustand';
import StoreCardComponentSkeleton from '@/components/StoreCardComponent/StoreCardComponentSkeleton';

// Improvement fix wording Pak Brian
function ProductsWeb({
    totalCount,
    getFilterProduct, 
    handleInput,
    setFilter,
    products,
    garasiList,
    brandOptions,
    yearOptions,
    modelOptions,
    typeOptions,
    isLoading,
    trigger_let_us_know,
    letUsKnowMessage,
    bannerImages,
    getListFilter,
    sorting_label,
    sorting_label_toko,
    responseFilter,
    getMatchFilter,
    setMatchFilter,
    deleteFilterMatch,
    recomendedGoods,
    recomendedStores,
    pagination,

    /* IMPROVEMENT FILTER ON PRODUCTS & HOMEPAGE */
    handleBrandLoadMore,
    handleYearLoadMore,
    handleModelLoadMore,
    handleTypeLoadMore,
    isBrandHasMore,
    isModelHasMore,
    isTypeHasMore,
    isYearHasMore,
}) {
    const {setShowToast, setDataToast}=toast()
    const [getMenuActive,setMenuActive]=useState('')
    const [defaultValueDropdown,setDefaultValueDropdown]=useState([])
    const [getState,setState]=useState({email:'',description:''})
    const { t } = useLanguage();
    const {selectedLocation}=userLocationZustan()
    // 25. 03 - QC Plan - Web - Pengecekan Ronda Muatparts - Tahap 2 - LB - 0431
    useEffect(()=>{
        if(!getFilterProduct.type ||getFilterProduct?.type==='produk')setMenuActive('produk')
        else setMenuActive('store')
    },[getFilterProduct])
    useEffect(()=>{
        if(letUsKnowMessage?.status==200) {
            setShowToast(true)
            setDataToast({ type: "success", message: "Berhasil Mengirim Masukan" })
            setState({email:'',description})
        }
    },[letUsKnowMessage])
    // IMP FILTER HOMEPAGE & PRODUCT
    return (
        <div className={`${style.main} ${style.web}`}>
            <Toast />
            {/* Filter */}
            <FilterProductsWeb 
            menu={getMenuActive} 
            garasiList={garasiList?.map(a=>({value:a?.id,name:`${a?.brand} ${a?.year}, ${a?.model}, ${a?.type}`}))} 
            getFilterProduct={getFilterProduct}
            brandOptions={brandOptions?.map(a=>({value:a?.id,name:a?.value}))}
            yearOptions={yearOptions?.map(a=>({value:a?.id.toString(),name:a?.value.toString()}))}
            modelOptions={modelOptions?.map(a=>({value:a?.id,name:a?.value}))}
            typeOptions={typeOptions?.map(a=>({value:a?.id,name:a?.value}))} 
            getListFilter={getListFilter}
            getMatchFilter={getMatchFilter}
            setMatchFilter={setMatchFilter}
            /* IMPROVEMENT FILTER ON PRODUCTS & HOMEPAGE */
            handleBrandLoadMore={handleBrandLoadMore}
            handleModelLoadMore={handleModelLoadMore}
            handleTypeLoadMore={handleTypeLoadMore}
            handleYearLoadMore={handleYearLoadMore}
            isBrandHasMore={isBrandHasMore}
            isModelHasMore={isModelHasMore}
            isYearHasMore={isYearHasMore}
            isTypeHasMore={isTypeHasMore} />

            {/* List Products */}
            <div className="flex flex-col w-full gap-4">
                <div className="flex justify-between">
                    <div className="flex items-center gap-1">
                        <div onClick={()=>{
                          getFilterProduct?.setFilterProduct('type','store')
                          getFilterProduct?.setFilterProduct('mode','')
                          getFilterProduct?.setFilterProduct('order','')
                          setDefaultValueDropdown([{name:'',value:''}])
                          getFilterProduct?.setFilterProduct('type','')
                          setMenuActive('produk')}} className={`select-none pb-2 cursor-pointer flex items-center px-6 gap-2 border-b-2 ${getMenuActive==='produk'?'border-primary-700':'border-neutral-50'} `}>
                            <IconComponent width={24} height={24} classname={`${getMenuActive==='produk'?style.iconActive:''}`} src={'/icons/product-web.svg'} />
                            <span className={`${getMenuActive==='produk'?'text-primary-700':'text-neutral-900'} text-base font-semibold`}>{t("labelProdukBuyer")}</span>
                        </div>
                        <span className='w-[1px] h-[80%] bg-neutral-400'></span>
                        <div onClick={()=>{
                          getFilterProduct?.setFilterProduct('type','store')
                          getFilterProduct?.setFilterProduct('mode','')
                          getFilterProduct?.setFilterProduct('order','')
                          setDefaultValueDropdown([{name:'',value:''}])
                          setMenuActive('store')}} className={`select-none pb-2 cursor-pointer flex items-center px-6 gap-2 border-b-2 ${getMenuActive==='store'?'border-primary-700':'border-neutral-50'}`}>
                            <IconComponent width={24} height={24} classname={`${getMenuActive==='store'?style.iconActive:''}`} src={'/icons/toko-web.svg'} />
                            <span className={`${getMenuActive==='store'?'text-primary-700':'text-neutral-900'} bold-base`}>{t("labelTokoBuyer")}</span>
                        </div>
                    </div>                    
                    <div className='flex items-center gap-6'>
                        <span className='text-sm font-medium text-[#1b1b1b]'>{t("labelHasilPencarian")}{getFilterProduct?.q&&<b className='font-bold'>“{getFilterProduct?.q}”</b>} ({pagination?.Total} {t("labelProdukBuyer")})</span>
                        <span className='flex gap-2 items-center border border-neutral-600 rounded-md pl-3'>
                            <span onClick={()=>{
                              if(getFilterProduct?.mode=='asc') getFilterProduct?.setFilterProduct('mode','desc')
                              else getFilterProduct?.setFilterProduct('mode','asc')
                            }}><IconComponent src={'/icons/sorting.svg'} classname={`${getFilterProduct?.mode?'icon-blue':''}`} /></span>
                            <Dropdown defaultValue={defaultValueDropdown} options={getFilterProduct?.type==='store'?sorting_label_toko:sorting_label} onSelected={(val)=>{
                              setDefaultValueDropdown(val)
                              if(val?.[0]?.value==='distance'){
                                getFilterProduct?.setFilterProduct('latitude',selectedLocation?.Latitude?selectedLocation?.Latitude:-7.2575)
                                getFilterProduct?.setFilterProduct('longitude',selectedLocation?.Longitude?selectedLocation?.Longitude:112.7521)
                              }
                              getFilterProduct?.setFilterProduct('order',val?.[0]?.value==='pricel'||val?.[0]?.value==='priceu'?'price':val?.[0]?.value)
                              getFilterProduct?.setFilterProduct('mode',getFilterProduct?.type==='store'?sorting_label_toko?.find(a=>a.value===val?.[0]?.value)?.mode:sorting_label?.find(a=>a.value===val?.[0]?.value)?.mode)
                            }} classname={'!border-none'} placeholder={t("labelPalingRelevan")} />
                        </span>
                    </div>
                </div>
                {getMatchFilter?.length?<div className='flex gap-3 items-center w-full'>
                  <span onClick={()=>{
                    getFilterProduct?.resetFilter()
                    setMatchFilter([])
                  }} className='bold-xs text-primary-700 select-none cursor-pointer whitespace-nowrap'>{t('LabelfilterProdukHapusFilter')}</span>
                  <CarouselScrollComponent hideButtons={false} className={'w-full max-w-[811px] scrollbar-none'} buttonSize={28}>
                    {getMatchFilter?.map((val,i)=> <Bubble key={i} classname={'whitespace-nowrap'} iconRight={<span className='cursor-pointer' onClick={()=>deleteFilterMatch(val)}><IconComponent src={'/icons/closes.svg'} width={12} height={12} classname={'icon-blue'} /></span>}>{val?.value}</Bubble>)}
                  </CarouselScrollComponent>
                </div>:''}
                {/* {
                    !isLoading?(!!(!products?.length)&&<div className='w-full flex flex-col gap-4 py-5'>
                    <DataNotFound textClass={'!font-semibold !text-sm !text-neutral-600 !w-[111px] !self-center'}><span className='semi-base text-neutral-600 mt-5'>{t("labelKeywordTidakDitemukanBuyer")}</span></DataNotFound>
                    <div className='flex flex-col gap-6 px-4 bg-neutral-50 py-5 border border-neutral-400 rounded-md'>
                      <div className={`flex gap-6 flex-col`}>
                        <div className='flex flex-col gap-4'>
                          <p className='font-bold text-[18px] text-neutral-900'>{t("labelBeritahukamiApayangKamuCari")}</p>
                          <p className='semi-sm text-neutral-900'>{t("labelMasukkanKamuAkanMembantu")}</p>
                        </div>
                        <div className={`${getMenuActive?.id==='produk'?'flex-col':'flex-col-reverse'} flex gap-6`}>
                          <div className='flex flex-col gap-4'>
                            25. 03 - QC Plan - Web - Pengecekan Ronda Muatparts - Tahap 2 - LB - 0689
                            <span className='medium-xs text-neutral-600 flex gap-1'>Email <i>{'(Opsional)'}</i></span>
                            <span className='medium-xs text-neutral-600 flex gap-1'>{t("LabelproductsbuyerEmail")}<i>{`(${t('LabelproductsbuyerOpsional')})`}</i></span>
                            <Input placeholder={t("LabelproductsbuyerPlaceholderEmail")} value={getState.email} changeEvent={(e)=>setState(prev=>({...prev,email:e.target.value}))} />
                          </div>
                          <div className='flex flex-col gap-4'>
                            <p className='medium-xs text-neutral-600'>{t("labelDeskripsiProduk")}</p>
                            <textarea onChange={(e)=>setState(prev=>({...prev,description:e.target.value}))} className='border border-neutral-600 rounded-md py-[11px] px-3 placeholder:text-sm placeholder:font-semibold placeholder:text-neutral-600 h-[80px] outline-none' placeholder={t("labelMohonDeskripsikanProduk")}></textarea>
                            <span className='medium-xs text-neutral-600 -mt-2 self-end'>{getState?.description?.length??0}/1.000 {t('LabelfilterProdukkarakter')}</span>
                          </div>
                        </div>
                      </div>
                      IMP MENDADAK
                      <Button disabled={!getState?.description?.length} Class='self-end h-7' onClick={()=>trigger_let_us_know(getState)}>{t("labelKirimProdukBuyer")}</Button>
                    </div>
                    
                    {isLoading&&<div className='flex flex-wrap gap-3'>{Array(12).fill('').map(val=><ProductComponentSkeleton/>)}</div>}
                    
                    </div>):(<div className='flex flex-wrap gap-3'>{Array(12).fill('').map(val=><ProductComponentSkeleton/>)}</div>)
                } */}
                {!isLoading && !products?.length && (
                  <div className='w-full flex flex-col gap-4 py-5'>
                    <DataNotFound textClass={'!font-semibold !text-sm !text-neutral-600 !w-[111px] !self-center'}><span className='semi-base text-neutral-600 mt-5'>{t("labelKeywordTidakDitemukanBuyer")}</span></DataNotFound>
                    <div className='flex flex-col gap-6 px-4 bg-neutral-50 py-5 border border-neutral-400 rounded-md'>
                      <div className={`flex gap-6 flex-col`}>
                        <div className='flex flex-col gap-4'>
                          <p className='font-bold text-[18px] text-neutral-900'>{t("labelBeritahukamiApayangKamuCari")}</p>
                          <p className='semi-sm text-neutral-900'>{t("labelMasukkanKamuAkanMembantu")}</p>
                        </div>
                        <div className={`${getMenuActive?.id==='produk'?'flex-col':'flex-col-reverse'} flex gap-6`}>
                          <div className='flex flex-col gap-4'>
                            {/* 25. 03 - QC Plan - Web - Pengecekan Ronda Muatparts - Tahap 2 - LB - 0689 */}
                            {/* <span className='medium-xs text-neutral-600 flex gap-1'>Email <i>{'(Opsional)'}</i></span> */}
                            <span className='medium-xs text-neutral-600 flex gap-1'>{t("LabelproductsbuyerEmail")}<i>{`(${t('LabelproductsbuyerOpsional')})`}</i></span>
                            <Input placeholder={t("LabelproductsbuyerPlaceholderEmail")} value={getState.email} changeEvent={(e)=>setState(prev=>({...prev,email:e.target.value}))} />
                          </div>
                          <div className='flex flex-col gap-4'>
                            <p className='medium-xs text-neutral-600'>{t("labelDeskripsiProduk")}</p>
                            <textarea onChange={(e)=>setState(prev=>({...prev,description:e.target.value}))} className='border border-neutral-600 rounded-md py-[11px] px-3 placeholder:text-sm placeholder:font-semibold placeholder:text-neutral-600 h-[80px] outline-none' placeholder={t("labelMohonDeskripsikanProduk")}></textarea>
                            <span className='medium-xs text-neutral-600 -mt-2 self-end'>{getState?.description?.length??0}/1.000 {t('LabelfilterProdukkarakter')}</span>
                          </div>
                        </div>
                      </div>
                      {/* IMP MENDADAK */}
                      <Button disabled={!getState?.description?.length} Class='self-end h-7' onClick={()=>trigger_let_us_know(getState)}>{t("labelKirimProdukBuyer")}</Button>
                    </div>
                  </div>
                )}
                {getMenuActive==='produk'&&(
                  <>
                    {
                      !isLoading?(
                        <>
                          {
                            // // LBM - fix 0 on empty state
                            products?.length>0 && (
                              <>
                                <div className='flex flex-wrap gap-3'>
                                  {
                                      products?.map(val=> <ProductComponent key={val.ID} {...val} />)
                                  }
                                  {/* <ProductComponentSkeleton/> */}
                                </div>
                                <Pagination perPage={getFilterProduct?.limit} onPerPageChange={a=>setFilter('limit',a)} currentPage={getFilterProduct?.page} onPageChange={a=>setFilter('page',a)} totalPages={pagination?.LastPage} />
                              </>
                            )
                          }
                        </>
                      ):(
                        <div className='flex flex-wrap gap-3'>
                          {Array(12).fill('').map(val=><ProductComponentSkeleton/>)}
                        </div>
                      )
                    }
                  </>
                )}

                {getMenuActive==='store'&&(
                  <>
                    {
                      !isLoading?(
                        <>
                          {
                            products?.length>0&&(
                              <>
                                <div className='flex flex-wrap gap-3'>
                                    {
                                        products?.map(val=><StoreCardComponent key={val.ID} {...val} />)
                                    }
                                </div>
                                <Pagination perPage={getFilterProduct?.limit} onPerPageChange={a=>setFilter('limit',a)} currentPage={getFilterProduct?.page} onPageChange={a=>setFilter('page',a)} totalPages={pagination?.LastPage} />
                              </>
                            )
                          }
                        </>
                      ):(
                        <div className='flex flex-wrap gap-3'>
                          {Array(12).fill('').map(val=><StoreCardComponentSkeleton/>)}
                        </div>
                      )
                    }
                  </>
                )}
                {/* {(getMenuActive==='produk'&&!isLoading&&products?.length)?<><div className='flex flex-wrap gap-3'>
                    {
                        products?.map(val=> <ProductComponent key={val.ID} {...val} />)
                    }
                </div>
                <Pagination perPage={getFilterProduct?.limit} onPerPageChange={a=>setFilter('limit',a)} currentPage={getFilterProduct?.page} onPageChange={a=>setFilter('page',a)} totalPages={pagination?.LastPage} />
                </>:''} */}
                
                
                {/* {(getMenuActive==='store'&&!isLoading&&products?.length)?<><div className='flex flex-wrap gap-3'>
                    {
                        products?.map(val=><StoreCardComponent key={val.ID} {...val} />)
                    }
                    
                </div>
                <Pagination perPage={getFilterProduct?.limit} onPerPageChange={a=>setFilter('limit',a)} currentPage={getFilterProduct?.page} onPageChange={a=>setFilter('page',a)} totalPages={pagination?.LastPage} />
                </>:''} */}
                
                <div className='flex flex-col gap-9 mt-2 w-[900px]'>
                  {
                    (getMenuActive==='produk'&&recomendedGoods?.length)?
                    <span className='font-semibold text-base text-neutral-900'>{t('LabelfilterProdukRekomendasiProdukLain')}</span>
                    :recomendedStores?.length?<span className='font-semibold text-base text-neutral-900'>{t('LabelfilterProdukRekomendasiPenjuallainuntukkamu')}</span>:''
                  }
                  {/* 25. 03 - QC Plan - Web - Pengecekan Ronda Muatparts - Tahap 2 - LB - 0586 */}
                  <CarouselScrollComponent isArrowAbsolute scrollAmount={192} className='flex w-full overflow-x-auto scrollbar-none' classNameContent={'!gap-3'}>
                    {
                      !!(getMenuActive==='produk')&& recomendedGoods?.map(val=><ProductComponent key={val.ID} {...val} />)
                    }
                    {
                      !!(getMenuActive==='store')&& recomendedStores?.map(val=><StoreCardComponent  key={val.ID} {...val} />)
                    }
                  </CarouselScrollComponent>
                </div>
                {(bannerImages?.length&&!isLoading)?<div className='w-full h-auto flex'>
                    <div className='w-auto max-h-[250px] min-w-[600px] max-w-[900px] mt-4'>
                        <MultipleItems 
                            images={bannerImages.map((val) => val.Image)}
                            urls={bannerImages.map((val) => val.Url)} 
                            settings={{
                                slidesToShow: 1,
                                slidesToScroll: 1,
                                autoplay: true,
                                autoplaySpeed: 3000,
                                dots: true,
                            }}
                            size={900}
                            className="rounded-xl" 
                        />
                    </div>
                </div>:''}
            </div>
        </div>
    );
}

export default ProductsWeb;
