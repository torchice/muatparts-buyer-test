'use client'
import { useCustomRouter } from "@/libs/CustomRoute"
import { authZustand } from "@/store/auth/authZustand"
import { userZustand } from "@/store/auth/userZustand"
import { userLocationZustan } from "@/store/manageLocation/managementLocationZustand"
import axios from "axios"
import { useSearchParams } from "next/navigation"
axios.interceptors.response.use(
    function(a){
        if(a?.status==200&&a?.headers?.["x-token"]){
            let token= a?.headers
            authZustand.getState().setToken({accessToken:token?.["x-token"],refreshToken:token?.["x-refreshtoken"]})
        }
        if(a?.status==401){
            userZustand.getState().removeUser()
            userLocationZustan?.getState().resetLocation()
        }
        // IMP - Under Maintenance muatparts
        if(a?.status === 503 && window){
            window.location.replace(process.env.NEXT_PUBLIC_INTERNAL_WEB + "sistem");
        }
        return a
    },
)
function ConfigUrl(urlCustom) {
    const token=authZustand()
    // 25. 03 - QC Plan - Web - Pengecekan Ronda Muatparts - Tahap 2 - LB - 0718
    const getLang = useSearchParams()
    const url=urlCustom?urlCustom:process.env.NEXT_PUBLIC_GLOBAL_API
    async function get({path,options}){
        try {
            const result = await axios.get(urlCustom?urlCustom:url+path,options?options:{
                headers:{
                    "Authorization":`Bearer ${token?.accessToken}`,
                    "refreshToken":token?.refreshToken,
                    "languageid":getLang.get('lang') || localStorage.getItem('lang') ||'id',
                    "platform":"web",
                    "loginas":"buyer"
                },
                ...options
            })
            return result
        } catch (error) {
            if(error?.status==401 || error?.status==403){
                userZustand.getState().removeUser()
            }
        }
        axios.delete()
    }
    async function post({path,data,options}){
        try {
            return axios.post(url+path,data,{
                headers:{
                    Authorization:'Bearer '+token?.accessToken,
                    "refreshToken":token?.refreshToken,
                    "languageid":getLang.get('lang') || localStorage.getItem('lang') ||'id',
                    "platform":"web",
                    "loginas":"buyer"
                },
                ...options
            }).then(a=>{
              return a
            })
        } catch (error) {
            if(error?.status==401 || error?.status==403){
                userZustand.getState().removeUser()
            }
        }
    }
    async function put({path,data,options}){
        try {
            return axios.put(url+path,data,{
                headers:{
                    Authorization:'Bearer '+token?.accessToken,
                    "refreshToken":token?.refreshToken,
                    "languageid":getLang.get('lang') || localStorage.getItem('lang') ||'id',
                    "platform":"web",
                    "loginas":"buyer"
                },
                ...options
            }).then(a=>{
              return a
            })
        } catch (error) {
            if(error?.status==401 || error?.status==403){
                userZustand.getState().removeUser()
            }
        }
    }
    async function deleted({path,options}){
        console.log("op",options)
        try {
            return axios.delete(url+path,{
                headers:{
                    Authorization:'Bearer '+token?.accessToken,
                    "refreshToken":token?.refreshToken,
                    "languageid":getLang.get('lang') || localStorage.getItem('lang') ||'id',
                    "platform":"web",
                    "loginas":"buyer"
                },
                ...options
            }).then(a=>{return a})
        } catch (error) {
            if(error?.status==401 || error?.status==403){
                userZustand.getState().removeUser()
            }
        }
    }
    return {
        get,
        post,
        put,
        deleted
    }
}

export default ConfigUrl